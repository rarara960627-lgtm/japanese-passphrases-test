<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å’æ¥­ç ”ç©¶ - è¨˜æ†¶è² è·å®Ÿé¨“</title>
    <!-- Tailwind CSSã‚’èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ãƒ•ã‚©ãƒ³ãƒˆã®æŒ‡å®šã¨å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #f3f4f6; /* Gray-100 */
        }
        #experiment-container {
            max-width: 90%;
            width: 768px; /* md:max-w-xl */
            min-height: 500px;
            margin: 40px auto;
            background-color: #ffffff;
            border-radius: 1rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .step {
            display: none;
            width: 100%;
            text-align: center;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px; /* æœ€å°é«˜ã•ã‚’è¨­å®š */
        }
        .step.active {
            display: flex;
        }
        .highlight-text {
            color: #10B981; /* Emerald-500 */
            font-weight: 700;
        }
        .timer-info {
            color: #6b7280; /* Gray-500 */
            margin-top: 1rem;
        }
    </style>
</head>
<body class="p-4">

    <div id="experiment-container">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-8 border-b-2 border-indigo-600 pb-2">è¨˜æ†¶è² è·å®Ÿé¨“</h1>

        <!-- 1. å°å…¥ã‚¹ãƒ†ãƒƒãƒ— -->
        <section id="intro-step" class="step active">
            <h2 class="text-2xl font-semibold mb-6 text-indigo-700">å‚åŠ è€…æƒ…å ±</h2>
            <p class="text-gray-700 mb-8">ã”å”åŠ›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ä»¥ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒ ã«ã‚ãªãŸã®<span class="highlight-text">å‚åŠ è€…ID</span>ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
            <div class="w-full max-w-sm">
                <label for="participant-id" class="block text-left text-sm font-medium text-gray-700 mb-2">å‚åŠ è€…ID (ä¾‹: P001):</label>
                <input type="text" id="participant-id" placeholder="IDã‚’å…¥åŠ›" required class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-center text-lg">
            </div>
            <button onclick="startExperiment()" class="mt-8 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg transition duration-150 shadow-md">
                å®Ÿé¨“ã‚’é–‹å§‹ã™ã‚‹
            </button>
        </section>

        <!-- 2. è¨˜æ†¶ã‚¹ãƒ†ãƒƒãƒ— -->
        <section id="memorize-step" class="step">
            <h2 class="text-2xl font-semibold mb-6 text-green-700">ã€è¨˜æ†¶ãƒ•ã‚§ãƒ¼ã‚ºã€‘ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’è¨˜æ†¶ã—ã¦ãã ã•ã„</h2>
            <p class="text-gray-700 mb-6">ä»¥ä¸‹ã®<span id="current-language" class="font-bold"></span>ã®ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’ã€<span class="highlight-text">å®Œå…¨ã«è¦šãˆã‚‹ã¾ã§</span>è¨˜æ†¶ã—ã¦ãã ã•ã„ã€‚ï¼ˆã‚³ãƒ”ãƒšä¸å¯ï¼‰</p>
            
            <div id="passphrase-display-box" class="bg-gray-100 p-8 rounded-xl shadow-inner max-w-full overflow-auto">
                <p id="passphrase-display" class="text-3xl font-mono text-gray-800 break-words">ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>

            <button onclick="endMemorize()" id="end-mem-btn" disabled class="mt-8 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg transition duration-150 shadow-md disabled:opacity-50">
                è¨˜æ†¶å®Œäº†
            </button>
            <p class="timer-info">â€»ã“ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¾ã§ã®æ™‚é–“ã‚’è¨ˆæ¸¬ã—ã¾ã™ã€‚</p>
        </section>

        <!-- 3. å¦¨å®³ã‚¹ãƒ†ãƒƒãƒ— (è¨ˆç®—ã‚¿ã‚¹ã‚¯) -->
        <section id="distractor-step" class="step">
            <h2 class="text-2xl font-semibold mb-6 text-red-700">ã€å¦¨å®³ã‚¿ã‚¹ã‚¯ã€‘30ç§’é–“ã®è¨ˆç®—</h2>
            <p class="text-gray-700 mb-4">é›†ä¸­ã—ã¦ä»¥ä¸‹ã®è¨ˆç®—ã‚’è§£ã„ã¦ãã ã•ã„ã€‚æ­£è§£ã™ã‚‹ãŸã³ã«æ¬¡ã®è¨ˆç®—ã«é€²ã¿ã¾ã™ã€‚</p>
            <div class="task-content bg-red-50 border border-red-200 p-6 rounded-xl shadow-lg w-full max-w-sm">
                <p class="text-gray-600 mb-2">æ®‹ã‚Šæ™‚é–“: <span id="distractor-timer" class="text-2xl font-extrabold text-red-600">30</span>ç§’</p>
                
                <p class="text-xl font-bold mt-4">ç¾åœ¨ã®æ•°å­—:</p>
                <p id="distractor-current-number" class="text-5xl font-extrabold text-red-700 mb-4">???</p>
                <p class="text-lg mb-4 text-gray-800">å¸¸ã« **3** ã‚’å¼•ãç¶šã‘ã¦ãã ã•ã„ã€‚</p>
                
                <p id="distractor-message" class="mb-4 font-medium text-center text-sm min-h-[1.5rem]"></p>
                
                <input type="number" id="distractor-input" placeholder="æ¬¡ã®æ•°å­—ã‚’å…¥åŠ›" class="p-3 border border-gray-400 rounded-lg text-center text-xl w-full max-w-xs mb-4 focus:ring-red-500 focus:border-red-500">
                
                <button onclick="checkDistractorInput()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition duration-150 shadow-md">
                    ç¢ºèª
                </button>
            </div>
        </section>

        <!-- 4. å†ç”Ÿã‚¹ãƒ†ãƒƒãƒ— -->
        <section id="recall-step" class="step">
            <h2 class="text-2xl font-semibold mb-6 text-blue-700">ã€å†ç”Ÿãƒ•ã‚§ãƒ¼ã‚ºã€‘ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºã®å†å…¥åŠ›</h2>
            <p class="text-gray-700 mb-4">è¨˜æ†¶ã—ãŸãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’ã€æ­£ç¢ºã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
            <div class="w-full max-w-lg">
                <p class="text-sm font-medium text-gray-600 mb-2">æ®‹ã‚Šã‚¨ãƒ©ãƒ¼è¨±å®¹å›æ•°: <span id="error-count-display" class="text-xl font-bold text-red-600">5</span>å›</p>
                <input type="text" id="recall-input" placeholder="ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šã§å…¥åŠ›ã—ã¦ãã ã•ã„" required class="w-full p-4 border-2 border-blue-300 rounded-lg shadow-inner text-lg focus:ring-blue-500 focus:border-blue-500">
                <button onclick="checkPassphrase()" id="check-btn" class="mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition duration-150 shadow-md">
                    ç¢ºèªã™ã‚‹
                </button>
                <p id="error-message" class="error text-red-500 mt-4 font-medium min-h-[1.5rem]"></p>
            </div>
        </section>

        <!-- 5. çµ‚äº†ã‚¹ãƒ†ãƒƒãƒ— -->
        <section id="finish-step" class="step">
            <h2 class="text-2xl font-semibold mb-6 text-gray-700">å®Ÿé¨“çµ‚äº†ã§ã™</h2>
            <div id="finish-message" class="p-6 bg-gray-100 rounded-xl w-full max-w-md">
                <p class="text-lg text-gray-600">ãƒ‡ãƒ¼ã‚¿é€ä¿¡å‡¦ç†ä¸­ã§ã™...</p>
            </div>
        </section>
        
    </div>

<script>
// script.js - ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºå®Ÿé¨“ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´åˆ¶å¾¡ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

let participantId = '';
let currentExperiment = {};Â 
let allExperimentResults = []; // ã™ã¹ã¦ã®ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆen/jp/pokemonï¼‰ã®çµæœã‚’ä¿æŒ

let currentPassphraseObject = null;Â 
let startTime = 0;Â 
let recallStartTime = 0;Â 
// æ½œä¼æ™‚é–“è¨ˆæ¸¬é–‹å§‹ç”¨ã®æ™‚åˆ»
let recallLatencyStartTime = 0;
let currentErrors = 0;
const MAX_ERRORS = 5;

let errorLog = []; 

// ã€å¦¨å®³ã‚¿ã‚¹ã‚¯ç”¨å¤‰æ•°ã€‘
let distractorTimerId;
let currentDistractorValue = 0; // ç¾åœ¨ã®è¨ˆç®—å€¤
let distractorErrors = 0; // å¦¨å®³ã‚¿ã‚¹ã‚¯ã§ã®èª¤ç­”å›æ•°ï¼ˆä»Šå›ã¯ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã«å«ã‚ãªã„ãŒã€æ‹¡å¼µæ€§ã®ãŸã‚ä¿æŒï¼‰


// !!! ã€é‡è¦ã€‘BASE_API_URLã‚’ã‚ãªãŸã®PythonAnywhereã®URLã«ç½®ãæ›ãˆã‚‹ !!!
// -----------------------------------------------------------------
const BASE_API_URL = 'https://raimu7260.pythonanywhere.com';
// -----------------------------------------------------------------


// --- UIåˆ¶å¾¡é–¢æ•° ---

/** ç‰¹å®šã®ã‚¹ãƒ†ãƒƒãƒ—IDã‚’è¡¨ç¤ºã—ã€ä»–ã‚’éè¡¨ç¤ºã«ã™ã‚‹ */
function showStep(id) {
    document.querySelectorAll('.step').forEach(step => {
        step.style.display = 'none';
    });
    // flexã‚’ä½¿ç”¨ã—ã¦è¦ç´ ã‚’ä¸­å¤®ã«é…ç½®ï¼ˆãƒ‡ã‚¶ã‚¤ãƒ³ã¯index.htmlä¾å­˜ï¼‰
    document.getElementById(id).style.display = 'flex'; 
}

/** ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆã‚’ç¦æ­¢ã—ã€ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºã®ä¸æ­£å–å¾—ã‚’é˜²ã */
function disableCopyPaste(elementId) {
    const displayElement = document.getElementById(elementId);
    if (!displayElement) return;

    displayElement.addEventListener('contextmenu', function(e) {
        e.preventDefault();
    });

    document.addEventListener('keydown', function(e) {
        // Ctrl+C / Cmd+C (ã‚³ãƒ”ãƒ¼) ã‚’ç¦æ­¢
        if (e.key === 'c' && (e.ctrlKey || e.metaKey)) {
            e.preventDefault();
        }
    });
    
    document.addEventListener('copy', function(e) {
         e.preventDefault();
    });
}


// --- å®Ÿé¨“åˆ¶å¾¡é–¢æ•° ---

function startExperiment() {
    participantId = document.getElementById('participant-id').value.trim();
    if (!participantId || participantId.length < 3) {
        // alert() ã®ä»£ã‚ã‚Šã«ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«ã¾ãŸã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ã‚’ä½¿ç”¨
        // ä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«console.errorã¨è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®ã¿
        const idInput = document.getElementById('participant-id');
        idInput.classList.add('border-red-500', 'ring-red-500');
        setTimeout(() => idInput.classList.remove('border-red-500', 'ring-red-500'), 2000);
        console.error("å‚åŠ è€…IDã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
    }
    
    // å®Ÿé¨“ã¯è‹±èªã‹ã‚‰é–‹å§‹
    startMemorizeStep('en');Â 
}

/** è¨€èªã‚³ãƒ¼ãƒ‰ã«å¿œã˜ã¦è¡¨ç¤ºåã‚’è¿”ã™ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° (ä¿®æ­£ç‰ˆ) */
function getLanguageDisplayName(languageCode) {
    switch (languageCode) {
        case 'en':
            return 'è‹±èªãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚º'; 
        case 'jp':
            return 'æ—¥æœ¬èªãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚º'; 
        case 'pokemon':
            return 'ãƒã‚±ãƒ¢ãƒ³ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚º'; 
        default:
            return 'ä¸æ˜';
    }
}

/** è¨˜æ†¶ã‚¹ãƒ†ãƒƒãƒ—ã®é–‹å§‹ï¼ˆãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºå–å¾—ã¨è¨ˆæ¸¬é–‹å§‹ï¼‰ */
async function startMemorizeStep(language) {
    showStep('memorize-step');
    document.getElementById('current-language').textContent = getLanguageDisplayName(language);
    document.getElementById('passphrase-display').textContent = 'ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’èª­ã¿è¾¼ã¿ä¸­...';
    document.getElementById('end-mem-btn').disabled = true;

    // è¨˜æ†¶ã‚¹ãƒ†ãƒƒãƒ—é–‹å§‹æ™‚ã« errorLog ã¨è©¦è¡Œå›æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
    currentErrors = 0;
    errorLog = [];

    currentExperiment = { 
        language: language, 
        participant_id: participantId, 
        passphrase_id: 'N/A',
        recall_latency_s: null // æ½œä¼æ™‚é–“ç”¨ã®ãƒ‡ãƒ¼ã‚¿é …ç›®ã‚’åˆæœŸåŒ–
    }; 

    // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æ–°ã—ã„ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’å–å¾—
    try {
        const response = await fetch(`${BASE_API_URL}/api/generate-passphrase/${language}`);
        const data = await response.json();

        if (response.ok) {
            currentPassphraseObject = {Â 
                passphrase: data.passphrase,
                language: data.language
            };
            document.getElementById('passphrase-display').textContent = currentPassphraseObject.passphrase;
            document.getElementById('end-mem-btn').disabled = false;
            
            // ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºè¡¨ç¤ºæ™‚ã«ã‚³ãƒ”ãƒšã‚’ç¦æ­¢
            disableCopyPaste('passphrase-display');

            // è¨˜æ†¶æ™‚é–“è¨ˆæ¸¬é–‹å§‹
            startTime = Date.now();
            console.log(`[${language}] è¨˜æ†¶è¨ˆæ¸¬é–‹å§‹`);

        } else {
            document.getElementById('passphrase-display').textContent = `ã‚¨ãƒ©ãƒ¼: ${data.error}`;
            console.error(`ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${data.error}`);
        }
    } catch (error) {
        console.error("ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚URLã¨æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚", error);
        showStep('intro-step'); // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å°å…¥ã«æˆ»ã™
    }
}

/** è¨˜æ†¶å®Œäº†ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸæ™‚ã®å‡¦ç† */
function endMemorize() {
    // è¨˜æ†¶æ™‚é–“ã‚’ç§’ã«å¤‰æ› (Date.now() - startTime) ã®çµæœã¯ãƒŸãƒªç§’ãªã®ã§ã€1000ã§å‰²ã£ã¦ç§’ã«å¤‰æ›
    const memorizeTime = (Date.now() - startTime) / 1000;
    // å˜ä½ã¯ã€Œmsã€ã ãŒã€ä¸­èº«ã¯ã€Œç§’ã€
    currentExperiment.memorize_time_ms = memorizeTime; 

    showStep('distractor-step');
    startDistractorStep(currentPassphraseObject.language);
}

// --- å¦¨å®³ã‚¿ã‚¹ã‚¯é–¢é€£ ---

/** å¦¨å®³ã‚¿ã‚¹ã‚¯ã®é–‹å§‹ (30ç§’ã‚¿ã‚¤ãƒãƒ¼ã¨è¨ˆç®—ã‚¿ã‚¹ã‚¯ã®é–‹å§‹) */
function startDistractorStep(language) {
    let timeLeft = 30;
    document.getElementById('distractor-timer').textContent = timeLeft;
    
    // 1. 3æ¡ã®åˆæœŸå€¤ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ç”Ÿæˆ (100ã‹ã‚‰999)
    currentDistractorValue = Math.floor(Math.random() * (999 - 100 + 1)) + 100;
    document.getElementById('distractor-current-number').textContent = currentDistractorValue;
    document.getElementById('distractor-input').value = '';
    document.getElementById('distractor-message').textContent = 'æ¬¡ã®æ•°å­—ã‚’å…¥åŠ›ã—ã€[ç¢ºèª]ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
    document.getElementById('distractor-input').focus();
    distractorErrors = 0;

    // 2. 30ç§’ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹
    distractorTimerId = setInterval(() => {
        timeLeft--;
        document.getElementById('distractor-timer').textContent = timeLeft;
        if (timeLeft <= 0) {
            clearInterval(distractorTimerId);
            startRecallStep(language); // å†ç”Ÿã‚¹ãƒ†ãƒƒãƒ—ã¸ç§»è¡Œ
        }
    }, 1000); // 1ç§’ã”ã¨ã«æ›´æ–°
}

/** å¦¨å®³ã‚¿ã‚¹ã‚¯ã®ç¢ºèªãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸæ™‚ã®å‡¦ç† */
function checkDistractorInput() {
    const inputElement = document.getElementById('distractor-input');
    const userInput = parseInt(inputElement.value.trim(), 10);
    const expectedValue = currentDistractorValue - 3;
    const messageDisplay = document.getElementById('distractor-message');
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ãŒæ•°å­—ã§ã‚ã‚Šã€ã‹ã¤æœŸå¾…å€¤ã¨ä¸€è‡´ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if (!isNaN(userInput) && userInput === expectedValue) {
        // æ­£è§£
        currentDistractorValue = userInput; // ç¾åœ¨ã®å€¤ã‚’æ›´æ–°
        document.getElementById('distractor-current-number').textContent = currentDistractorValue; // ç”»é¢ã‚’æ›´æ–°
        inputElement.value = ''; // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
        messageDisplay.textContent = 'âœ… æ­£è§£ï¼æ¬¡ã®æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
        messageDisplay.style.color = '#10B981'; // Tailwind: emerald-500
    } else {
        // ä¸æ­£è§£ or ç„¡åŠ¹ãªå…¥åŠ›
        distractorErrors++;
        messageDisplay.textContent = 'âŒ é–“é•ã„ã§ã™ã€‚ã‚‚ã†ä¸€åº¦è¨ˆç®—ã—ã¦ãã ã•ã„ã€‚';
        messageDisplay.style.color = '#EF4444'; // Tailwind: red-500
        inputElement.value = ''; // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
    }
    inputElement.focus(); // å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’æˆ»ã™
}

// --- å†ç”Ÿã‚¿ã‚¹ã‚¯é–¢é€£ ---

/** æ½œä¼æ™‚é–“ã‚’è¨ˆæ¸¬ã—ã€ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ã™ã‚‹ãƒãƒ³ãƒ‰ãƒ© (æœ€åˆã®ã‚­ãƒ¼å…¥åŠ›æ™‚ã®ã¿å®Ÿè¡Œ) */
const handleFirstKey = (event) => {
    // æ½œä¼æ™‚é–“ï¼ˆç§’ï¼‰ã‚’è¨ˆç®—: (ç¾åœ¨ã®æ™‚åˆ» - è¨ˆæ¸¬é–‹å§‹æ™‚åˆ») / 1000
    const latency = (Date.now() - recallLatencyStartTime) / 1000;
    currentExperiment.recall_latency_s = latency;
    console.log(`[${currentPassphraseObject.language}] æ½œä¼æ™‚é–“: ${latency.toFixed(3)}s`);

    // æ½œä¼æ™‚é–“ã®è¨ˆæ¸¬ã¯1å›ãã‚Šãªã®ã§ã€ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
    document.getElementById('recall-input').removeEventListener('keydown', handleFirstKey);
};

/** å†ç”Ÿã‚¹ãƒ†ãƒƒãƒ—ã®é–‹å§‹ */
function startRecallStep(language) {
    showStep('recall-step');
    document.getElementById('error-count-display').textContent = MAX_ERRORS;
    document.getElementById('recall-input').value = '';Â 
    document.getElementById('error-message').textContent = '';
    
    // ä»¥å‰ã®æ½œä¼æ™‚é–“è¨ˆæ¸¬ç”¨ã®ãƒªã‚¹ãƒŠãƒ¼ãŒæ®‹ã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§å‰Šé™¤
    document.getElementById('recall-input').removeEventListener('keydown', handleFirstKey);
    
    document.getElementById('recall-input').focus(); // å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
    
    // å†ç”Ÿæ™‚é–“è¨ˆæ¸¬é–‹å§‹
    recallStartTime = Date.now();Â 
    console.log(`[${language}] å†ç”Ÿè¨ˆæ¸¬é–‹å§‹`);

    // æ½œä¼æ™‚é–“è¨ˆæ¸¬ã®é–‹å§‹
    recallLatencyStartTime = Date.now();
    // æœ€åˆã®ã‚­ãƒ¼å…¥åŠ›ã§æ½œä¼æ™‚é–“ã‚’è¨˜éŒ²ã™ã‚‹ãŸã‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
    document.getElementById('recall-input').addEventListener('keydown', handleFirstKey, { once: true });
}


// --- ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: ã‚¹ãƒšãƒ¼ã‚¹ã‚’æ­£è¦åŒ–ã—ã¦æ¯”è¼ƒ ---
function normalizePassphrase(passphrase) {
    // 1. å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ã‚’åŠè§’ã«ç½®æ›
    // 2. ã™ã¹ã¦ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’å‰Šé™¤ï¼ˆå˜èªã®ä¸¦ã³é †ã®ã¿ã‚’ãƒã‚§ãƒƒã‚¯ï¼‰
    // ç›®çš„: åŠè§’ãƒ»å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ã‚’è¨±å®¹ã—ã€å˜èªã®é †åºã®ã¿ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹
    return passphrase
        .replace(/ã€€/g, ' ') // å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ã‚’åŠè§’ã‚¹ãƒšãƒ¼ã‚¹ã«å¤‰æ›
        .replace(/\s+/g, '') // é€£ç¶šã™ã‚‹ã‚¹ãƒšãƒ¼ã‚¹ã€ã¾ãŸã¯æ®‹ã£ãŸã‚¹ãƒšãƒ¼ã‚¹ã‚’ã™ã¹ã¦å‰Šé™¤ 
        .trim();
}


/** ç¢ºèªãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸæ™‚ã®å‡¦ç† (å†ç”Ÿãƒ†ã‚¹ãƒˆ) */
function checkPassphrase() {
    const userInput = document.getElementById('recall-input').value.trim();
    const expectedPassphrase = currentPassphraseObject.passphrase;
    const language = currentPassphraseObject.language;

    // æ­£èª¤åˆ¤å®šã¯ã€ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç„¡è¦–ã—ãŸæ–‡å­—åˆ—ã§æ¯”è¼ƒ
    const normalizedUserInput = normalizePassphrase(userInput);
    const normalizedExpected = normalizePassphrase(expectedPassphrase);

    // æ­£ã—ã„å…¥åŠ›ã‹ã€ã¾ãŸã¯è¦å®šã®è©¦è¡Œå›æ•°ã«é”ã—ãŸã‹ã‚’ãƒã‚§ãƒƒã‚¯
    const isCorrect = (normalizedUserInput === normalizedExpected);
    
    // æˆåŠŸã¾ãŸã¯æœ€çµ‚è©¦è¡Œï¼ˆå¤±æ•—ï¼‰æ™‚ã®å‡¦ç†
    if (isCorrect || currentErrors >= MAX_ERRORS - 1) { 
        
        if (!isCorrect && currentErrors >= MAX_ERRORS - 1) {
            // æœ€å¾Œã®è©¦è¡Œã‚‚å¤±æ•—ã—ãŸå ´åˆã€è©¦è¡Œå›æ•°ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
            currentErrors++;Â 
        }

        // ğŸ’¡ å†ç”Ÿæ™‚é–“ã¯ã€æ­£è§£ãŒç¢ºèªã•ã‚ŒãŸæ™‚ç‚¹ã€ã¾ãŸã¯æœ€çµ‚è©¦è¡ŒãŒçµ‚ã‚ã£ãŸæ™‚ç‚¹ã§è¨˜éŒ²
        const recallTime = (Date.now() - recallStartTime) / 1000;
        currentExperiment.recall_time_ms = recallTime;
        
        // æ½œä¼æ™‚é–“è¨ˆæ¸¬ç”¨ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ï¼ˆä¿é™ºï¼‰
        document.getElementById('recall-input').removeEventListener('keydown', handleFirstKey);

        // å¤±æ•—ã—ãŸå ´åˆã€æœ€å¾Œã®è©¦è¡Œã‚’ãƒ­ã‚°ã«è¨˜éŒ²
        if (!isCorrect) {
             errorLog.push({
                 // è¨˜éŒ²ã™ã‚‹ã®ã¯ã€æƒ³èµ·é–‹å§‹ã‹ã‚‰ã®çµŒéç§’æ•°
                 time_s: recallTime, 
                 input_value: userInput, // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç”Ÿå…¥åŠ›
                 attempt: currentErrors // è©¦è¡Œå›æ•°
             });
        }
        
        // æ½œä¼æ™‚é–“ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ãªã„å ´åˆï¼ˆã‚­ãƒ¼ã‚’æŠ¼ã•ãšã«ç¢ºèªãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸå ´åˆãªã©ï¼‰ã¯ 0 ã‚’è¨˜éŒ²
        if (currentExperiment.recall_latency_s === null) {
            currentExperiment.recall_latency_s = 0;
        }

        // error_count ã¯ã€å¤±æ•—ã—ã¦è¨˜éŒ²ã•ã‚ŒãŸãƒ­ã‚°ã®æ•°
        currentExperiment.error_count = errorLog.length;
        currentExperiment.is_success = isCorrect;
        currentExperiment.passphrase = currentPassphraseObject.passphrase;
        currentExperiment.error_details = errorLog;
        
        allExperimentResults.push(currentExperiment); // çµæœã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ 
        
        let nextLanguage;
        // å®Ÿé¨“ãƒ•ãƒ­ãƒ¼ã®å®šç¾©ï¼ˆen -> jp -> pokemon -> finishï¼‰
        if (language === 'en') {
            nextLanguage = 'jp';
        } else if (language === 'jp') {
            nextLanguage = 'pokemon';
        } else {
            nextLanguage = 'finish'; // 'pokemon' ã®æ¬¡ã¯çµ‚äº†
        }


        // æ¬¡ã®ãƒ–ãƒ­ãƒƒã‚¯ã¸ç§»è¡Œã€ã¾ãŸã¯çµ‚äº†
        if (nextLanguage !== 'finish') {
             startMemorizeStep(nextLanguage);
        } else {
             showStep('finish-step');
             handleFinalDataSubmit(); // å…¨ãƒ–ãƒ­ãƒƒã‚¯å®Œäº†å¾Œã€ãƒ‡ãƒ¼ã‚¿é€ä¿¡
        }
        
    } else {
        // é–“é•ã„ (è©¦è¡Œå›æ•°ã‚’å¢—ã‚„ã™)
        currentErrors++;
        
        // è¨˜éŒ²ã™ã‚‹ã®ã¯ã€æƒ³èµ·é–‹å§‹ã‹ã‚‰ã®çµŒéç§’æ•°
        const errorTime = (Date.now() - recallStartTime) / 1000;
        errorLog.push({
            time_s: errorTime, // ç¢ºèªãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ™‚ç‚¹ã®çµŒéç§’æ•°
            input_value: userInput, // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç”Ÿå…¥åŠ›
            attempt: currentErrors // è©¦è¡Œå›æ•°
        });
        
        document.getElementById('error-count-display').textContent = MAX_ERRORS - currentErrors;
        document.getElementById('recall-input').value = ''; // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
        
        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        document.getElementById('error-message').textContent = `âŒ é–“é•ã„ã§ã™ã€‚å†å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚æ®‹ã‚Šè©¦è¡Œå›æ•°: ${MAX_ERRORS - currentErrors}`;
        document.getElementById('error-message').style.color = 'red';

        // å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’æˆ»ã™
        document.getElementById('recall-input').focus(); 
    }
}

// --- ãƒ‡ãƒ¼ã‚¿é€ä¿¡ ---

/** æœ€çµ‚ãƒ‡ãƒ¼ã‚¿ã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã™ã‚‹å‡¦ç† */
async function handleFinalDataSubmit() {
    const API_URL = `${BASE_API_URL}/api/save-result`;Â 
    const messageDisplay = document.getElementById('finish-message');
    
    messageDisplay.innerHTML = '<p class="text-lg text-gray-600">ãƒ‡ãƒ¼ã‚¿é€ä¿¡ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„...</p>';

    try {
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(allExperimentResults)Â 
        });

        if (response.ok) {
            console.log('ãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•ä¿å­˜ã«æˆåŠŸã—ã¾ã—ãŸï¼');
            messageDisplay.innerHTML = '<h2 class="text-2xl font-bold text-green-600 mb-2">âœ… ãƒ‡ãƒ¼ã‚¿ä¿å­˜å®Œäº†</h2><p class="text-gray-700">å®Ÿé¨“ã«ã”å”åŠ›ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒç ”ç©¶è€…ã«é€ä¿¡ã•ã‚Œã¾ã—ãŸã€‚</p>';
        } else {
            const errorData = await response.json();
            console.error('ä¿å­˜å¤±æ•—:', errorData.error);
            messageDisplay.innerHTML = `<h2 class="text-2xl font-bold text-red-600 mb-2">âŒ ãƒ‡ãƒ¼ã‚¿ä¿å­˜å¤±æ•—</h2><p class="text-gray-700">è‡ªå‹•ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ç ”ç©¶è€…ã«ã“ã®ç”»é¢ã¨ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰: ${response.status} ã‚’ã”é€£çµ¡ãã ã•ã„ã€‚</p>`;
        }
    } catch (error) {
        console.error('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼:', error);
        messageDisplay.innerHTML = '<h2 class="text-2xl font-bold text-red-600 mb-2">âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼</h2><p class="text-gray-700">ã‚µãƒ¼ãƒãƒ¼ã¨ã®æ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã€ç ”ç©¶è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚</p>';
    }

}

// å¤–éƒ¨å…¬é–‹ãŒå¿…è¦ãªé–¢æ•°ã‚’ window ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«è¿½åŠ 
window.startExperiment = startExperiment;
window.endMemorize = endMemorize;
window.checkDistractorInput = checkDistractorInput;
window.checkPassphrase = checkPassphrase;
</script>

</body>
</html>
